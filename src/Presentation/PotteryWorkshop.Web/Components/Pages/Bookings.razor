@page "/bookings"
@rendermode InteractiveServer
@inject IBookingService BookingService
@inject ISnackbar Snackbar

<PageTitle>Bookings</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Bookings</MudText>

<MudCard Class="mb-4">
    <MudCardContent>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">
            Create Booking
        </MudButton>
    </MudCardContent>
</MudCard>

@if (_isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (_bookings == null || !_bookings.Any())
{
    <MudAlert Severity="Severity.Info">No bookings found. Create your first booking!</MudAlert>
}
else
{
    <MudTable Items="@_bookings" Hover="true" Striped="true" Elevation="4">
        <HeaderContent>
            <MudTh>Workshop</MudTh>
            <MudTh>Customer</MudTh>
            <MudTh>Date</MudTh>
            <MudTh>Participants</MudTh>
            <MudTh>Amount</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Workshop">@context.WorkshopTitle</MudTd>
            <MudTd DataLabel="Customer">@context.CustomerName</MudTd>
            <MudTd DataLabel="Date">@context.BookingDate.ToString("MMM dd, yyyy")</MudTd>
            <MudTd DataLabel="Participants">@context.NumberOfParticipants</MudTd>
            <MudTd DataLabel="Amount">$@context.TotalAmount</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">@context.Status</MudChip>
            </MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" />
                <MudIconButton Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" OnClick="@(() => CancelBooking(context.Id))" />
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private IEnumerable<BookingDto>? _bookings;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        _isLoading = true;
        try
        {
            _bookings = await BookingService.GetAllBookingsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading bookings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task CancelBooking(int id)
    {
        try
        {
            await BookingService.CancelBookingAsync(id);
            await LoadBookings();
            Snackbar.Add("Booking cancelled successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error cancelling booking: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Confirmed" => Color.Success,
            "Pending" => Color.Warning,
            "Cancelled" => Color.Error,
            "Completed" => Color.Info,
            _ => Color.Default
        };
    }
}
